#!/bin/bash

BEATS_VER="6.8.1"
BEATS_OSS="-oss"
BEATS_DEB_URL_TEMPLATE_REPLACER="XXXXX"
BEATS_DEB_URL_TEMPLATE="https://artifacts.elastic.co/downloads/beats/$BEATS_DEB_URL_TEMPLATE_REPLACER/$BEATS_DEB_URL_TEMPLATE_REPLACER$BEATS_OSS-$BEATS_VER-amd64.deb"

# tweak some dashboards for, then install filebeat/metricbeat/auditbeat/packetbeat
for BEAT in filebeat metricbeat auditbeat packetbeat; do
  BEATS_URL="$(echo "$BEATS_DEB_URL_TEMPLATE" | sed "s/$BEATS_DEB_URL_TEMPLATE_REPLACER/$BEAT/g")"
  BEATS_DEB="$BEAT-$BEATS_VER-amd64.deb"
  BEATS_NEW_DEB="$BEAT-dark-$BEATS_VER-amd64.deb"
  BEATS_TMP_DIR="$BEAT-deb"
  pushd /tmp && \
    curl -f -L -o "$BEATS_DEB" "$BEATS_URL" && \
    dpkg-deb -x "$BEATS_DEB" "$BEATS_TMP_DIR" && \
    dpkg-deb -e "$BEATS_DEB" "$BEATS_TMP_DIR/DEBIAN" && \
    sed -i 's@\(\\"darkTheme\\" *: *\)false@\1true@g' "$BEATS_TMP_DIR"/usr/share/$BEAT/kibana/?/dashboard/*.json && \
    ( [[ "$BEAT" == "metricbeat" ]] && sed -i -e "s@ |\\\\\\\n\[Containers overview\](#/dashboard/CPU-slash-Memory-per-container)@@g" "$BEATS_TMP_DIR"/usr/share/$BEAT/kibana/?/dashboard/* || true ) && \
    dpkg-deb -b "$BEATS_TMP_DIR" "$BEATS_NEW_DEB" && \
    rm -rf "$BEATS_TMP_DIR" && \
    dpkg -i "$BEATS_NEW_DEB" && \
    rm -rf "$BEATS_TMP_DIR" "$BEATS_DEB" "$BEATS_NEW_DEB" && \
    popd
done

# remove some dashboards we don't care about (for clutter)
rm -f /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-apache-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-containers-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-docker-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-golang-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-haproxy-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-kafka-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-kubernetes-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-mongodb-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-mysql-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-nginx-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-rabbitmq-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-redis-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-uwsgi-*json \
      /usr/share/metricbeat/kibana/6/dashboard/?etricbeat-windows-*json \
      /usr/share/auditbeat/kibana/6/dashboard/auditbeat-kernel-executions.json \
      /usr/share/auditbeat/kibana/6/dashboard/auditbeat-kernel-overview.json \
      /usr/share/auditbeat/kibana/6/dashboard/auditbeat-kernel-sockets.json \
      /usr/share/filebeat/kibana/6/dashboard/*json

# add symlinks to our custom dashboards
FILES=$(shopt -s nullglob dotglob; echo /usr/share/filebeat/kibana/6/dashboard-custom/*)
if (( ${#FILES} )) ; then
  ln -s -r -f /usr/share/filebeat/kibana/6/dashboard-custom/* /usr/share/filebeat/kibana/6/dashboard/
fi
FILES=$(shopt -s nullglob dotglob; echo /usr/share/metricbeat/kibana/6/dashboard-custom/*)
if (( ${#FILES} )) ; then
  ln -s -r -f /usr/share/metricbeat/kibana/6/dashboard-custom/* /usr/share/metricbeat/kibana/6/dashboard/
fi
FILES=$(shopt -s nullglob dotglob; echo /usr/share/auditbeat/kibana/6/dashboard-custom/*)
if (( ${#FILES} )) ; then
  ln -s -r -f /usr/share/auditbeat/kibana/6/dashboard-custom/* /usr/share/auditbeat/kibana/6/dashboard/
fi

###

# set up capabilities for network-related tools
chown root:netdev /usr/share/auditbeat/bin/auditbeat && \
  setcap 'CAP_AUDIT_READ+eip' /usr/share/auditbeat/bin/auditbeat

###
