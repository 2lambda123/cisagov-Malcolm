<!doctype html>

<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <link rel="stylesheet" href="./mapping.css">
  <script src="./jquery.min.js"></script>
  <title>Host and Network Segment Name Mapping</title>
</head>

<body>

  <div id="container" class="mapping-page">
    <div id="main">
      <div class="c1">
        <img class="center" src="Malcolm_banner.png" alt="">
        <h1>Host and Network Segment Name Mapping</h1>
        <div id="mapping">
          <table>
            <thead>
              <tr>
                <th class="sort" data-sort="type">Type</th>
                <th class="sort" data-sort="address">Address</th>
                <th class="sort" data-sort="name">Name</th>
                <th class="sort" data-sort="tag">Tag (optional)</th>
                <th colspan="2">
                  <input type="text" class="search" placeholder="Search mappings" />
                </th>
              </tr>
            </thead>
            <tbody class="list"/>
            <tfoot>
              <tr>
                <td class="type">
                  <input type="hidden" id="id-field" />
                  <select id="type-field">
                    <option value="host">host</option>
                    <option value="segment">segment</option>
                  </select>
                </td>
                <td class="address">
                  <input type="text" id="address-field" placeholder="Address" />
                </td>
                <td class="name">
                  <input type="text" id="name-field" placeholder="Name" />
                </td>
                <td class="tag">
                  <input type="text" id="tag-field" placeholder="Tag (optional)" />
                </td>
                <td class="add" colspan="2">
                  <button id="add-btn">Add</button>
                  <button id="update-btn">Update</button>
                  <button id="cancel-btn">Cancel</button>
                </td>
              </tr>
              <tr>
                <td/>
                <td/>
                <td class="foot" colspan="2">
                  <button id="save-btn">Save Mappings</button>
                </td>
                <td class="foot" colspan="2">
                  <button id="restart-btn">Restart Log Ingestion</button>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div> <!-- end of #container .mapping-page -->

  <script src="./list.min.js"></script>
  <script type="text/javascript">

    // define value names and template for new list items
    var options = {
      valueNames: [ 'id', 'type', 'address', 'name', 'tag' ],
      item: '<tr><td class="id" style="display:none;"><td class="type"></td></td><td class="address"></td><td class="name"></td><td class="tag"></td><td class="update"><button class="edit-item-btn">Edit</button></td><td class="remove"><button class="remove-item-btn">Remove</button></td></tr>'
    };

    // initialize list and other elements
    var mappingList = new List('mapping', options);

    var idField = $('#id-field'),
        typeField = $('#type-field'),
        addressField = $('#address-field'),
        nameField = $('#name-field'),
        tagField = $('#tag-field'),
        addBtn = $('#add-btn'),
        updateBtn = $('#update-btn').hide(),
        cancelBtn = $('#cancel-btn').hide(),
        saveBtn = $('#save-btn'),
        restartBtn = $('#restart-btn'),
        removeBtns = $('.remove-item-btn'),
        editBtns = $('.edit-item-btn');

    // sets callbacks to the buttons in the list
    refreshCallbacks();

    // store a new value from the edit inputs into the list
    addBtn.click(function() {
      mappingList.add({
        // todo: better random ID generator (if necessary)
        id: Math.floor(Math.random()*110000),
        type: typeField.val(),
        address: addressField.val(),
        name: nameField.val(),
        tag: tagField.val()
      });
      clearFields();
      refreshCallbacks();
    });

    // update an item being edited back into the list
    updateBtn.click(function() {
      const itemId = idField.val();
      var item = mappingList.get('id', itemId)[0];
      item.values({
        id:idField.val(),
        type: typeField.val(),
        address: addressField.val(),
        name: nameField.val(),
        tag: tagField.val()
      });
      clearFields();
      updateBtn.hide();
      cancelBtn.hide();
      addBtn.show();

      // scroll back up to item that was updated
      // todo: is there a more efficient way to do this? there's got to be with list.js
      for (const editBtnKey in editBtns) {
        if (editBtnKey && (editBtns[editBtnKey])) {
          entry = (editBtns[editBtnKey].closest) ? editBtns[editBtnKey].closest('tr').firstChild : null;
          if (entry && entry.firstChild && entry.firstChild.data && (String(entry.firstChild.data) === String(itemId))) {
            editBtns[editBtnKey].focus();
            break;
          }
        }
      }
    });

    // revert edits without updating
    cancelBtn.click(function() {
      clearFields();
      updateBtn.hide();
      cancelBtn.hide();
      addBtn.show();
    });

    saveBtn.click(function() {
      console.log('save');
    });

    restartBtn.click(function() {
      console.log('restart');
    });

    // apply callbacks for the buttons on the list items
    function refreshCallbacks() {

      removeBtns = $(removeBtns.selector);
      editBtns = $(editBtns.selector);

      // delete item
      removeBtns.click(function() {
        var itemId = $(this).closest('tr').find('.id').text();
        mappingList.remove('id', itemId);
      });

      // populate the edit inputs from the values of row where Edit was clicked
      editBtns.click(function() {
        var itemId = $(this).closest('tr').find('.id').text();
        var itemValues = mappingList.get('id', itemId)[0].values();
        idField.val(itemValues.id);
        typeField.val(itemValues.type);
        addressField.val(itemValues.address);
        nameField.val(itemValues.name);
        tagField.val(itemValues.tag);

        updateBtn.show();
        cancelBtn.show();
        addBtn.hide();
        window.scrollTo(0,document.body.scrollHeight);
        // focus and scroll to editing fields
        addressField.focus();
        addressField.select();
      });
    }

    // clear edit inputs
    function clearFields() {
      typeField.val('host');
      addressField.val('');
      nameField.val('');
      tagField.val('');
    }

    // load old delimited plain text format
    //   IP or MAC address to host name map:
    //     address|host name|required tag
    //   CIDR to network segment format:
    //     IP(s)|segment name|required tag
    ['/maps/cidr-map.txt', '/maps/host-map.txt'].forEach(function (txtUrl, txtUrlIdx) {
      const mapType = (txtUrlIdx === 0) ? "segment" : "host";
      var txtFile = new XMLHttpRequest();
      txtFile.open("GET", txtUrl, true);
      txtFile.send();
      txtFile.onreadystatechange = function() {
        if ((txtFile.readyState === 4) && (txtFile.status === 200)) {
          txtFile.responseText.split(/\r?\n/).forEach(function (line, lineIdx) {
            if (!line.startsWith("#")) {
              const vals = line.split("|");
              const valsLen = vals.length;
              if ((valsLen >= 2) && (valsLen < 4)) {
                const name = vals[1].trim();
                const tag = (valsLen > 2) ? vals[2].trim() : "";
                const addrs = vals[0].trim().split(",");
                addrs.forEach(function (addr, addrIdx) {
                  // todo: better random ID generator (if necessary)
                  mappingList.add({
                    id: Math.floor(Math.random()*110000),
                    type: mapType,
                    address: addr,
                    name: name,
                    tag: tag
                  });
                  // todo: this is stupid to call this for every item... js callbacks are dumb
                  refreshCallbacks();
                });
              }
            }
          });
        }
      }
    });

  </script> <!-- end of ListJS-related scripts -->

</body>
</html>